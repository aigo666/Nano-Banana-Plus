import{d as Z,r as g,o as W,c as l,a as r,b as e,e as v,f as k,w as C,g as Q,t as a,h as p,n as A,F as B,i as H,j as E,H as S,k as I}from"./index-CwaSU5TM.js";const Y={class:"min-h-screen bg-gray-50"},G={class:"bg-white border-b border-gray-200"},R={class:"container mx-auto px-4 py-4"},$={class:"flex items-center justify-between"},J={class:"flex items-center gap-4"},U={class:"flex items-center gap-3"},V={class:"container mx-auto px-4 py-8 max-w-6xl"},F={class:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"},X={class:"bg-white rounded-xl shadow-sm p-4 text-center border border-gray-100"},K={class:"text-2xl font-bold text-blue-600 mb-1"},q={class:"bg-white rounded-xl shadow-sm p-4 text-center border border-gray-100"},O={class:"text-2xl font-bold text-green-600 mb-1"},ee={class:"bg-white rounded-xl shadow-sm p-4 text-center border border-gray-100"},te={class:"text-2xl font-bold text-red-600 mb-1"},se={class:"bg-white rounded-xl shadow-sm p-4 text-center border border-gray-100"},oe={class:"text-2xl font-bold text-orange-600 mb-1"},le={class:"bg-white rounded-2xl shadow-lg border border-gray-100"},re={class:"p-6"},ae={key:0,class:"text-center py-12"},ne={key:1,class:"text-center py-12"},ie={class:"text-gray-600 text-sm mb-4"},de={key:0,class:"mb-4"},ue={class:"text-orange-600 text-sm"},ce={class:"w-32 h-1 bg-gray-200 rounded-full mx-auto mt-2"},ge={class:"space-x-3"},ve=["disabled"],be={key:2,class:"text-center py-12"},xe={key:3,class:"space-y-2"},me={class:"flex items-center gap-4"},pe={class:"flex-shrink-0"},he={class:"flex-1 min-w-0"},ye={class:"flex items-center gap-3 mb-1"},fe={class:"text-gray-500 text-sm"},_e=["title"],we={class:"flex items-center gap-2 flex-shrink-0"},ke={key:0,class:"flex gap-1"},Ce=["onClick"],Ie=["src","alt"],je={key:0,class:"w-10 h-10 bg-gray-100 rounded border border-gray-300 flex items-center justify-center text-gray-500 text-xs"},Me={key:1,class:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Ne=["onClick"],Be=["src"],He={key:3,class:"w-12 h-12 bg-red-50 rounded border border-red-200 flex items-center justify-center"},Se={key:4,class:"mt-6 flex justify-center"},De={class:"flex items-center gap-2"},ze=["disabled"],Le={class:"px-4 py-2 text-sm text-gray-600 bg-gray-50 rounded-lg"},Pe=["disabled"],Te={class:"bg-gray-900 text-white px-6 py-4 flex items-center justify-between"},Ze={class:"font-semibold"},We={class:"p-6"},Qe=["src","alt"],h=3,Ge=Z({__name:"History",setup(Ae){const x=g(!1),u=g(null),i=g(0),_=g([]),b=g({total_generations:0,successful_generations:0,failed_generations:0,total_consumed_times:0}),d=g({page:1,limit:20,total:0,totalPages:0}),y=g(null),f=g(""),m=async(o=1,t=!1)=>{const c=isNaN(o)||o<1?1:Math.floor(o);console.log("Loading history for page:",c,t?"(重试)":""),x.value=!0,t||(u.value=null,i.value=0);try{const s=await S.getUserHistory(c,20);_.value=s.items,d.value=s.pagination,u.value=null,i.value=0,console.log("历史记录加载成功:",s)}catch(s){console.error("加载历史记录失败:",s);const n=s instanceof Error?s.message:"加载历史记录失败";u.value=n,i.value<h&&!n.includes("登录")&&!n.includes("权限")&&(i.value++,console.log(`将在2秒后自动重试 (${i.value}/${h})`),setTimeout(()=>{u.value&&m(c,!0)},2e3))}finally{x.value=!1}},D=()=>{i.value=0,m(d.value.page)},z=async()=>{try{console.log("Loading user stats..."),b.value=await S.getUserStats(),console.log("Stats loaded successfully:",b.value)}catch(o){console.error("加载统计信息失败:",o),b.value={total_generations:0,successful_generations:0,failed_generations:0,total_consumed_times:0}}},j=(o,t)=>{y.value=o,f.value=t},M=()=>{y.value=null,f.value=""},N=o=>{const t=o.target;t.src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEg0NFY0NEgyMFYyMFoiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI4IDI4TDM2IDM2TDQwIDMyIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo="},L=o=>({pending:"等待中",processing:"生成中",completed:"已完成",failed:"生成失败"})[o]||o,P=o=>{const t=new Date(o),s=new Date().getTime()-t.getTime(),n=Math.floor(s/(1e3*60*60*24));return n===0?t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):n===1?"昨天":n<7?`${n}天前`:t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},T=()=>{const o=localStorage.getItem("token"),t=localStorage.getItem("user");return console.log("认证状态检查:",{hasToken:!!o,hasUser:!!t,tokenPreview:o?o.substring(0,20)+"...":null}),o?!0:(console.warn("未找到认证令牌，可能需要重新登录"),u.value="登录已过期，请重新登录",!1)};return W(()=>{console.log("History 组件已挂载，开始初始化..."),T()&&(m(),z())}),(o,t)=>{const c=Q("router-link");return r(),l("div",Y,[e("header",G,[e("div",R,[e("nav",$,[e("div",J,[k(c,{to:"/",class:"flex items-center gap-2 hover:scale-105 transition-transform"},{default:C(()=>[...t[4]||(t[4]=[e("span",{class:"text-3xl"},"🍌",-1),e("div",{class:"flex items-center gap-1"},[e("span",{class:"text-xl md:text-2xl font-bold text-gray-800"},"Nano"),e("span",{class:"text-xl md:text-2xl font-bold text-orange-500"},"Banana")],-1)])]),_:1}),t[5]||(t[5]=e("div",{class:"flex items-center gap-2"},[e("svg",{class:"w-5 h-5 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})]),e("h1",{class:"text-lg md:text-xl font-bold text-gray-800"},"创作历史")],-1))]),e("div",U,[k(c,{to:"/",class:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all"},{default:C(()=>[...t[6]||(t[6]=[p(" 返回首页 ",-1)])]),_:1})])])])]),e("div",V,[e("div",F,[e("div",X,[e("div",K,a(b.value.total_generations),1),t[7]||(t[7]=e("div",{class:"text-gray-600 text-sm"},"总生成次数",-1))]),e("div",q,[e("div",O,a(b.value.successful_generations),1),t[8]||(t[8]=e("div",{class:"text-gray-600 text-sm"},"成功生成",-1))]),e("div",ee,[e("div",te,a(b.value.failed_generations),1),t[9]||(t[9]=e("div",{class:"text-gray-600 text-sm"},"生成失败",-1))]),e("div",se,[e("div",oe,a(b.value.total_consumed_times),1),t[10]||(t[10]=e("div",{class:"text-gray-600 text-sm"},"消耗次数",-1))])]),e("div",le,[t[22]||(t[22]=e("div",{class:"px-6 py-4 border-b border-gray-100"},[e("h2",{class:"text-lg font-semibold text-gray-900 flex items-center gap-2"},[e("svg",{class:"w-5 h-5 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})]),p(" 创作历史记录 ")])],-1)),e("div",re,[x.value?(r(),l("div",ae,[...t[11]||(t[11]=[e("div",{class:"w-8 h-8 border-2 border-blue-300 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"},null,-1),e("p",{class:"text-gray-600"},"加载中...",-1)])])):u.value?(r(),l("div",ne,[t[12]||(t[12]=e("svg",{class:"w-12 h-12 text-red-500 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})],-1)),t[13]||(t[13]=e("p",{class:"text-red-600 font-semibold mb-2"},"加载失败",-1)),e("p",ie,a(u.value),1),i.value>0&&i.value<h?(r(),l("div",de,[e("p",ue,"正在自动重试中... ("+a(i.value)+"/"+a(h)+")",1),e("div",ce,[e("div",{class:"h-full bg-orange-500 rounded-full animate-pulse",style:A({width:i.value/h*100+"%"})},null,4)])])):v("",!0),e("div",ge,[e("button",{onClick:D,class:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",disabled:x.value},a(x.value?"重试中...":"重试"),9,ve),u.value.includes("登录")||u.value.includes("权限")?(r(),l("button",{key:0,onClick:t[0]||(t[0]=()=>{o.localStorage.clear(),o.window.location.href="/login"}),class:"bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-all"}," 重新登录 ")):v("",!0)])])):_.value.length===0?(r(),l("div",be,[t[15]||(t[15]=e("svg",{class:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"})],-1)),t[16]||(t[16]=e("p",{class:"text-gray-600 font-semibold mb-2"},"还没有创作记录",-1)),t[17]||(t[17]=e("p",{class:"text-gray-500 text-sm mb-4"},"去首页开始您的第一次AI创作吧！",-1)),k(c,{to:"/",class:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium inline-block transition-all"},{default:C(()=>[...t[14]||(t[14]=[p(" 开始创作 ",-1)])]),_:1})])):(r(),l("div",xe,[(r(!0),l(B,null,H(_.value,s=>(r(),l("div",{key:s.id,class:"border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:bg-blue-50/30 transition-all"},[e("div",me,[e("div",pe,[e("div",{class:I([{"bg-green-500":s.status==="completed","bg-red-500":s.status==="failed","bg-yellow-500":s.status==="processing","bg-gray-400":s.status==="pending"},"w-3 h-3 rounded-full"])},null,2)]),e("div",he,[e("div",ye,[e("span",{class:I([{"bg-green-100 text-green-700":s.status==="completed","bg-red-100 text-red-700":s.status==="failed","bg-yellow-100 text-yellow-700":s.status==="processing","bg-gray-100 text-gray-700":s.status==="pending"},"px-2 py-1 rounded-md text-xs font-medium"])},a(L(s.status)),3),e("span",fe,a(P(s.created_at)),1),e("span",{class:I([{"text-blue-600":s.status==="completed"&&s.consumed_times>0,"text-gray-500":s.status==="failed"||s.consumed_times===0},"text-sm font-medium"])},a(s.status==="failed"?"未消耗":s.consumed_times>0?`消耗${s.consumed_times}次`:"未消耗"),3)]),e("p",{class:"text-gray-700 text-sm truncate",title:s.prompt},a(s.prompt),9,_e)]),e("div",we,[s.original_images&&s.original_images.length>0?(r(),l("div",ke,[(r(!0),l(B,null,H(s.original_images.slice(0,2),(n,w)=>(r(),l("button",{key:w,onClick:Ee=>j(n,`参考图片 ${w+1}`),class:"w-10 h-10 bg-gray-100 rounded border border-gray-300 hover:border-blue-400 transition-colors overflow-hidden"},[e("img",{src:n,alt:`参考图片 ${w+1}`,class:"w-full h-full object-cover",onError:N},null,40,Ie)],8,Ce))),128)),s.original_images.length>2?(r(),l("div",je," +"+a(s.original_images.length-2),1)):v("",!0)])):v("",!0),s.original_images&&s.original_images.length>0&&s.generated_image?(r(),l("svg",Me,[...t[18]||(t[18]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"},null,-1)])])):v("",!0),s.generated_image?(r(),l("button",{key:2,onClick:n=>j(s.generated_image,"生成结果"),class:"w-12 h-12 bg-gray-100 rounded border-2 border-blue-300 hover:border-blue-500 transition-colors overflow-hidden"},[e("img",{src:s.generated_image,alt:"生成结果",class:"w-full h-full object-cover",onError:N},null,40,Be)],8,Ne)):s.status==="failed"?(r(),l("div",He,[...t[19]||(t[19]=[e("svg",{class:"w-5 h-5 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])):v("",!0)])])]))),128))])),d.value.totalPages>1?(r(),l("div",Se,[e("div",De,[e("button",{onClick:t[1]||(t[1]=()=>m(d.value.page-1)),disabled:d.value.page<=1,class:"px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-1"},[...t[20]||(t[20]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1),p(" 上一页 ",-1)])],8,ze),e("span",Le," 第 "+a(d.value.page)+" / "+a(d.value.totalPages)+" 页 ",1),e("button",{onClick:t[2]||(t[2]=()=>m(d.value.page+1)),disabled:d.value.page>=d.value.totalPages,class:"px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-1"},[...t[21]||(t[21]=[p(" 下一页 ",-1),e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)])],8,Pe)])])):v("",!0)])])]),y.value?(r(),l("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",onClick:M},[e("div",{class:"max-w-4xl max-h-full bg-white rounded-2xl overflow-hidden shadow-2xl",onClick:t[3]||(t[3]=E(()=>{},["stop"]))},[e("div",Te,[e("h3",Ze,a(f.value),1),e("button",{onClick:M,class:"text-gray-300 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors"},[...t[23]||(t[23]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",We,[e("img",{src:y.value,alt:f.value,class:"max-w-full max-h-[70vh] object-contain mx-auto rounded-lg"},null,8,Qe)])])])):v("",!0)])}}});export{Ge as default};
